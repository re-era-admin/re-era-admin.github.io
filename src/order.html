<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./common/css/common.css" />
    <link rel="stylesheet" href="./css/order.css" />
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.js"
      integrity="sha256-DrT5NfxfbHvMHux31Lkhxg42LY6of8TaYyK50jnxRnM="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/parsley.js/2.9.2/parsley.min.js"
      integrity="sha512-eyHL1atYNycXNXZMDndxrDhNAegH2BDWt1TmkXJPoGf1WLlNYt08CSjkqF5lnCRmdm3IrkHid8s2jOUY4NIZVQ=="
      crossorigin="anonymous"
    ></script>
    <title>オンライン横丁 flatto -出店申請フォーム-</title>
  </head>
  <body>
    <!-- Scrolls -->
    <div id="main">
      <div class="containers container_form">
        <div class="area area_pageTitle">
          <div class="part">
            <h1 id="inputForm_title">出店申請フォーム</h1>
            <h1 id="comfirmForm_title">出店申請確認画面</h1>
          </div>
        </div>
        <div class="area" id="area_inputForm">
          <form
            id="orderForm"
            　data-parsley-trigger="keyup focusout change input"
          >
            <div class="part">
              <p>出店名[30文字まで]*</p>
              <input
                id="bar_name"
                name="出店名"
                class="inputData"
                required
                data-parsley-openDate
                maxlength="30"
                placeholder="(例)居酒屋 flatto"
                data-parsley-error-message="必須項目です。"
              />
            </div>
            <!-- TODO サーバから認証情報に合致するオーナIDを取得する -->
            <input
              name="オーナーId"
              class="inputData"
              value="1234567890123456789012345A"
              id="owner_id"
            />
            <div class="part">
              <p>チケット購入形態*</p>
              <select
                id="ticket_pattern"
                class="inputData"
                name="チケット購入形態"
              >
                <option value="1">予約先着型</option>
                <option value="2">ふらっと型</option>
                <option value="3">抽選型</option>
              </select>
            </div>
            <div class="part">
              <p>トークジャンル[50文字まで]*</p>
              <input
                id="talk_genre"
                name="トークジャンル"
                class="inputData"
                required
                placeholder="(例)雑談"
                data-parsley-error-message="必須項目です。"
              />
            </div>
            <div class="part">
              <p>お店の説明*</p>
              <textarea
                id="description"
                name="お店の説明"
                class="inputData"
                required
                data-parsley-error-message="必須項目です。"
              ></textarea>
            </div>
            <div class="part">
              <p>お店の説明要約1[20文字]</p>
              <input
                id="description_outline1"
                name="お店の説明要約1"
                class="inputData"
                maxlength="20"
              />
            </div>
            <div class="part">
              <p>お店の説明要約2[20文字]</p>
              <input
                id="description_outline2"
                name="お店の説明要約2"
                class="inputData"
                maxlength="20"
              />
            </div>
            <div class="part">
              <p>お店の説明要約3[20文字]</p>
              <input
                id="description_outline3"
                name="お店の説明要約3"
                class="inputData"
                maxlength="20"
              />
            </div>
            <div class="part">
              <p>お客様席数 (店主様分はこの中に含みません)*</p>
              <select id="seats" class="inputData" name="席数">
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1</option>
              </select>
            </div>
            <div class="part">
              <p>チケット価格(円) 0も設定可能*</p>
              <input
                id="price"
                name="チケットの値段"
                class="inputData"
                placeholder="(例)5000"
                required
                data-parsley-type="integer"
                data-parsley-error-message="チケット価格を数字で入力してください。"
              />
            </div>
            <div class="part">
              <p>
                チケットの単位時間(分) [30分以上〜]*<br />
                ※お客様が滞在できる時間です。
              </p>
              <input
                id="unit_time"
                name="単位時間"
                class="inputData"
                required
                data-parsley-type="integer"
                data-parsley-min="30"
                data-parsley-error-message="チケット単位時間は30以上の数字を設定してください。"
              />
            </div>
            <div class="part">
              <p>お店の開店時間(現在時刻よりも10分後以降)* 〜閉店時間</p>
              <input
                id="start-date"
                class="inputData start-time"
                type="date"
                required
                data-parsley-openDate=""
                data-parsley-error-message="必須項目です。"
              /><input
                class="minimum_text start-time"
                id="start-hour"
                data-parsley-type="integer"
                data-parsley-max="23"
              />時<input
                class="minimum_text start-time"
                id="start-min"
                data-parsley-type="integer"
                data-parsley-max="59"
              />分〜
              <!-- リクエスト用に日付と時間を結合したものを格納するinput 非表示 -->
              <input
                type="datetime-local"
                class="hiddenData"
                id="開店時間"
                name="開店時間"
              />
              <input
                id="end-date"
                class="inputData"
                type="date"
                required
                data-parsley-openDate=""
                data-parsley-error-message="必須項目です。"
              />
              <input
                class="minimum_text"
                id="end-hour"
                data-parsley-type="integer"
                data-parsley-max="23"
              />時<input
                class="minimum_text"
                id="end-min"
                data-parsley-type="integer"
                data-parsley-max="59"
              />分
              <!-- リクエスト用に日付と時間を結合したものを格納するinput 非表示 -->
              <input
                type="datetime-local"
                class="hiddenData"
                id="閉店時間"
                name="閉店時間"
              />
            </div>
            <div class="part">
              <button type="button" id="check_btn">確認画面へ</button>
              <button type="button" id="submit">申請する</button>
              <button type="button" id="remake_btn">申請内容を修正する</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="container__modal" class="container__modal">
      <div class="m-w9v"></div>
      <div class="box__modal" :class="{ 'active' : msg }">
        <div class="part__modal-title">
          <p1 v-cloak>{{ msg.title }}</p1>
        </div>
        <div id="part__modal-icon" class="part__modal-icon">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="icon icon-tabler icon-tabler-alert-triangle"
            width="68"
            height="68"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="#FFEB3B"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" />
            <path d="M12 9v2m0 4v.01" />
            <path
              d="M5.07 19H19a2 2 0 0 0 1.75 -2.75L13.75 4a2 2 0 0 0 -3.5 0L3.25 16.25a2 2 0 0 0 1.75 2.75"
            />
          </svg>
        </div>
        <div class="m-h2v"></div>
        <div class="part__modal-text">
          <p v-cloak>{{ msg.text }}</p>
        </div>
        <div class="m-h6v"></div>
        <div class="part__btn-top">
          <button id="close">閉じる</button>
        </div>
      </div>
      <div class="m-w9v"></div>
    </div>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAcahSSBT9jzNddDlvPLMLIsUFSsagmN4g",
        authDomain: "flatto-yokocho.firebaseapp.com",
        databaseURL: "https://flatto-yokocho.firebaseio.com",
        projectId: "flatto-yokocho",
        storageBucket: "flatto-yokocho.appspot.com",
        messagingSenderId: "699983020092",
        appId: "1:699983020092:web:d29c1bd9f1b62817904339",
        measurementId: "G-7J94N3VHRE",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      window.onload = function () {
        firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
          } else {
            // location.href = "./login.html";　//TODO ログインページの改修が完了するまで
          }
        });
      };
      $("#orderForm").parsley();
      function test() {
        $("#orderForm").parsley().validate();
      }
      document.getElementById("check_btn").addEventListener(
        "click",
        function (event) {
          $("#orderForm").parsley().validate();
          event.preventDefault();
        },
        false
      );
      document.getElementById("remake_btn").addEventListener(
        "click",
        function (event) {
          switchInputForm();
          event.preventDefault();
        },
        false
      );
      $("#orderForm")
        .parsley()
        .on("form:success", function () {
          nowDate = new Date();
          var openDateTime = new Date(
            document.getElementById("開店時間").value
          );
          var endDateTime = new Date(document.getElementById("閉店時間").value);
          var error_message = "";
          if (nowDate.setMinutes(nowDate.getMinutes() + 10) > openDateTime) {
            error_message =
              error_message +
              "お店の開店時間は今から10分以上後にして下さい。\n";
          }

          //単位時間以下になっていおない事
          if (
            (endDateTime - openDateTime) / 60000 <
            document.getElementById("unit_time").value
          ) {
            //60000ミリ秒=1分
            error_message =
              error_message +
              "お店の開店開店時間と閉店時間の間は最低でもチケットの単位時間の設定時間(" +
              document.getElementById("unit_time").value +
              "分)よりも開けてください。\n";
          }

          if (endDateTime < openDateTime) {
            error_message =
              error_message +
              "お店の開店開店時間と閉店時間が前後しています。\n";
          }

          if (error_message == "") {
            switchComfirmForm();
          } else {
            alert(error_message);
          }
        });

      function switchInputForm() {
        var inputDatas = document.getElementsByClassName("inputData");
        for (var i = 0; i < inputDatas.length; i++) {
          inputDatas[i].disabled = false;
        }
        document.getElementById("check_btn").style.display = "block";
        document.getElementById("submit").style.display = "none";
        document.getElementById("remake_btn").style.display = "none";
        document.getElementById("inputForm_title").style.display = "block";
        document.getElementById("comfirmForm_title").style.display = "none";
      }

      function switchComfirmForm() {
        var inputDatas = document.getElementsByClassName("inputData");
        for (var i = 0; i < inputDatas.length; i++) {
          inputDatas[i].disabled = true;
        }
        document.getElementById("check_btn").style.display = "none";
        document.getElementById("submit").style.display = "block";
        document.getElementById("remake_btn").style.display = "block";
        document.getElementById("inputForm_title").style.display = "none";
        document.getElementById("comfirmForm_title").style.display = "block";
        document.getElementById("main").style.backgroundColor = "#ddd";
      }

      function sendRequest() {
        switchInputForm();
        var formElement = document.getElementById("orderForm");
        var formData = new FormData(formElement);
        formData.forEach(function (element, index, array) {
          console.log(index);
        });

        fetch(
          process.env.AP_CONTEXT_PATH + "/出店情報/出店情報の登録を申請する",
          // process.env.AP_CONTEXT_PATH + "/日付テスト",
          {
            method: "POST",
            body: formData,
          }
        )
          .then((response) => response.json())
          .catch((error) => console.error("Error:", error))
          .then((response) => {
            // document
            //   .getElementById("container__loading")
            //   .classList.remove("active");
            // document.getElementById("header").classList.add("under-modal");
            if (response.code != undefined) {
              console.log("Fail", response.message);
              document
                .getElementById("part__modal-icon")
                .classList.add("error");
              var vm = new Vue({
                el: "#container__modal",
                data: {
                  msg: [],
                },
                mounted() {
                  const result = {
                    title: "",
                    text: response.message,
                  };
                  this.msg = result;
                },
              });
              return;
            }
            console.log("Success", JSON.stringify(response));
            location.href("./acceptOffer.html");
          });
      }
      document.getElementById("submit").addEventListener("click", sendRequest);

      document
        .getElementById("close")
        .addEventListener("click", function (event) {
          document.getElementsById("container__modal").style.display = "none";
        });

      document
        .querySelector("#start-date")
        .addEventListener("change", (event) => {
          createStartDateTime();
        });
      document
        .querySelector("#start-hour")
        .addEventListener("change", (event) => {
          createStartDateTime();
        });
      document
        .querySelector("#start-min")
        .addEventListener("change", (event) => {
          createStartDateTime();
        });

      document
        .querySelector("#end-date")
        .addEventListener("change", (event) => {
          createEndDateTime();
        });
      document
        .querySelector("#end-hour")
        .addEventListener("change", (event) => {
          createEndDateTime();
        });
      document.querySelector("#end-min").addEventListener("change", (event) => {
        createEndDateTime();
      });

      function createStartDateTime() {
        const _startDate = document.querySelector("#start-date").value;
        const _startHour = (
          "00" + document.querySelector("#start-hour").value
        ).slice(-2);
        const _startMin = (
          "00" + document.querySelector("#start-min").value
        ).slice(-2);
        const result = document.querySelector("#開店時間");
        result.value = _startDate + "T" + _startHour + ":" + _startMin;
      }

      function createEndDateTime() {
        const _endDate = document.querySelector("#end-date").value;
        const _endHour = (
          "00" + document.querySelector("#end-hour").value
        ).slice(-2);
        const _endMin = ("00" + document.querySelector("#end-min").value).slice(
          -2
        );
        const result = document.querySelector("#閉店時間");
        result.value = _endDate + "T" + _endHour + ":" + _endMin;
      }
    </script>
  </body>
</html>
